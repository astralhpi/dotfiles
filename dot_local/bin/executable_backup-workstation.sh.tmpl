#!/bin/bash
#
# Workstation Backup Script
# 원격 워크스테이션의 홈 디렉토리를 로컬로 백업합니다.
#

set -euo pipefail

# === 설정 ===
SSH_HOST="work"
REMOTE_PATH="/home/{{ .work_user }}/"
LOCAL_PATH="{{ .work_backup_dest }}"
LOG_FILE="$LOCAL_PATH/.backup.log"

# === 제외 목록 ===
EXCLUDES=(
    # 캐시
    '.cache'
    '.local/share/Trash'
    '.Trash'
    
    # Node.js / Bun
    'node_modules'
    '.npm'
    '.bun'
    '.pnpm-store'
    
    # Python
    '.venv'
    'venv'
    '__pycache__'
    '.mypy_cache'
    '.pytest_cache'
    '.ruff_cache'
    '.ipynb_checkpoints'
    
    # Rust
    'target'
    '.cargo/registry'
    '.cargo/git'
    '.rustup/toolchains'
    '.rustup/tmp'
    
    # Go
    'go/pkg'
    
    # Java / Kotlin
    '.gradle'
    '.m2/repository'
    'build'
    '.idea'
    
    # Elm
    'elm-stuff'
    
    # Zig
    'zig-cache'
    '.zig'
    
    # Misc
    '*.log'
    '*.tmp'
    '.DS_Store'
    'Thumbs.db'
)

# === 함수 ===
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

notify_error() {
    terminal-notifier \
        -title "Workstation Backup" \
        -message "$1" \
        -sound Basso \
        -group "backup-workstation"
}

notify_success() {
    # 성공은 조용히 (원하면 주석 해제)
    : # no-op
    # terminal-notifier \
    #     -title "Workstation Backup" \
    #     -message "$1" \
    #     -sound Glass \
    #     -group "backup-workstation"
}

check_network() {
    # expensive 네트워크 (테더링/셀룰러) 체크
    if scutil --nwi 2>/dev/null | grep -q "expensive : true"; then
        log "Expensive network detected (tethering). Skipping backup."
        exit 0
    fi
}

check_tailscale() {
    # Tailscale 연결 확인
    if ! command -v tailscale &>/dev/null; then
        log "Tailscale not found. Skipping backup."
        exit 0
    fi
    
    if ! tailscale status &>/dev/null; then
        log "Tailscale not connected. Skipping backup."
        exit 0
    fi
}

check_host_reachable() {
    # SSH 호스트 연결 가능 여부 (타임아웃 5초)
    if ! ssh -o ConnectTimeout=5 -o BatchMode=yes "$SSH_HOST" "exit 0" &>/dev/null; then
        log "Host '$SSH_HOST' not reachable. Skipping backup."
        exit 0
    fi
}

run_backup() {
    # 제외 옵션 생성
    local exclude_opts=()
    for pattern in "${EXCLUDES[@]}"; do
        exclude_opts+=(--exclude="$pattern")
    done
    
    # 백업 디렉토리 생성
    mkdir -p "$LOCAL_PATH"
    
    log "Starting backup from $SSH_HOST:$REMOTE_PATH to $LOCAL_PATH"
    
    # rsync 실행
    # --archive: 권한, 시간 등 보존
    # --compress: 전송 시 압축
    # --delete: 소스에서 삭제된 파일은 백업에서도 삭제
    # --delete-excluded: 제외 패턴에 해당하는 파일도 백업에서 삭제
    # --partial: 중단된 전송 재개 가능
    # --progress: 진행 상황 표시 (로그용)
    if rsync \
        --archive \
        --compress \
        --delete \
        --delete-excluded \
        --partial \
        --human-readable \
        "${exclude_opts[@]}" \
        -e "ssh -o ConnectTimeout=30" \
        "$SSH_HOST:$REMOTE_PATH" \
        "$LOCAL_PATH/" \
        >> "$LOG_FILE" 2>&1; then
        
        log "Backup completed successfully."
        notify_success "Backup completed"
        return 0
    else
        local exit_code=$?
        log "Backup failed with exit code $exit_code"
        notify_error "Backup failed (exit code: $exit_code)"
        return $exit_code
    fi
}

# === 메인 ===
main() {
    # 전제 조건 확인
    check_network
    check_tailscale
    check_host_reachable
    
    # 백업 실행
    run_backup
}

main "$@"
