#!/usr/bin/env bash

set -uo pipefail

cmd_exists() { command -v "$1" >/dev/null 2>&1; }

# 개별 설치 함수 - 실패해도 계속 진행
try_install() {
  local name="$1"
  shift
  echo "==> Installing $name..."
  if "$@"; then
    echo "    $name installed successfully"
  else
    echo "    WARNING: $name installation failed, skipping..."
  fi
}

install_homebrew_if_needed() {
  if [[ "$(uname)" == "Darwin" ]] && ! cmd_exists brew; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  fi
}

{{ if eq .chezmoi.os "linux" -}}
install_arch_packages() {
  echo "==> Installing Arch Linux packages..."
  sudo pacman -Syu --noconfirm \
    base-devel \
    tmux \
    zellij \
    neovim \
    fzf \
    ripgrep \
    fd \
    direnv \
    ncurses \
    python-pipx \
    lsd \
    zoxide || echo "WARNING: Some pacman packages failed to install"

  # pipx PATH 설정
  pipx ensurepath 2>/dev/null || true

  # mise
  if ! cmd_exists mise && [[ ! -f ~/.local/bin/mise ]]; then
    try_install "mise" bash -c 'curl https://mise.run | sh'
  fi

  # starship
  if ! cmd_exists starship && [[ ! -f ~/.local/bin/starship ]]; then
    try_install "starship" bash -c 'curl -sS https://starship.rs/install.sh | sh -s -- -y -b ~/.local/bin'
  fi

  # atuin
  if [[ ! -f ~/.atuin/bin/atuin ]]; then
    try_install "atuin" bash -c 'curl --proto "=https" --tlsv1.2 -LsSf https://setup.atuin.sh | sh'
  fi
}

install_debian_packages() {
  echo "==> Installing Debian/Ubuntu packages..."
  sudo apt-get update
  sudo apt-get install -y \
    build-essential \
    tmux \
    neovim \
    fzf \
    ripgrep \
    fd-find \
    direnv \
    ncurses-term \
    pipx || echo "WARNING: Some apt packages failed to install"
  
  # pipx PATH 설정
  pipx ensurepath 2>/dev/null || true

  # lsd (apt에 없어서 직접 설치)
  if ! cmd_exists lsd; then
    try_install "lsd" bash -c '
      LSD_VERSION=$(curl -s https://api.github.com/repos/lsd-rs/lsd/releases/latest | grep -oP "\"tag_name\": \"v?\K[^\"]+")
      curl -fsSL "https://github.com/lsd-rs/lsd/releases/download/v${LSD_VERSION}/lsd_${LSD_VERSION}_{{ .chezmoi.arch }}.deb" -o /tmp/lsd.deb
      sudo dpkg -i /tmp/lsd.deb
      rm -f /tmp/lsd.deb
    '
  fi

  # mise
  if ! cmd_exists mise && [[ ! -f ~/.local/bin/mise ]]; then
    try_install "mise" bash -c 'curl https://mise.run | sh'
  fi

  # starship
  if ! cmd_exists starship && [[ ! -f ~/.local/bin/starship ]]; then
    try_install "starship" bash -c 'curl -sS https://starship.rs/install.sh | sh -s -- -y -b ~/.local/bin'
  fi

  # atuin
  if [[ ! -f ~/.atuin/bin/atuin ]]; then
    try_install "atuin" bash -c 'curl --proto "=https" --tlsv1.2 -LsSf https://setup.atuin.sh | sh'
  fi

  # zoxide
  if ! cmd_exists zoxide && [[ ! -f ~/.local/bin/zoxide ]]; then
    try_install "zoxide" bash -c 'curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh'
  fi

  # zellij
  if ! cmd_exists zellij && [[ ! -f ~/.local/bin/zellij ]]; then
    try_install "zellij" bash -c '
      ZELLIJ_VERSION=$(curl -s https://api.github.com/repos/zellij-org/zellij/releases/latest | grep -oP "\"tag_name\": \"v?\K[^\"]+")
      curl -fsSL "https://github.com/zellij-org/zellij/releases/download/v${ZELLIJ_VERSION}/zellij-x86_64-unknown-linux-musl.tar.gz" | tar -xz -C ~/.local/bin
    '
  fi
}

install_linux_packages() {
  {{ if or (eq .chezmoi.osRelease.id "arch") (eq .chezmoi.osRelease.id "archarm") -}}
  install_arch_packages
  {{ else -}}
  install_debian_packages
  {{ end -}}

  # Set zsh as default shell
  if [[ "$SHELL" != *"zsh"* ]]; then
    echo "==> Setting zsh as default shell..."
    sudo chsh -s "$(which zsh)" "$USER" || echo "WARNING: Failed to change default shell"
  fi
}
{{ end -}}

main() {
  install_homebrew_if_needed
{{ if eq .chezmoi.os "linux" -}}
  install_linux_packages
{{ end -}}
  echo "==> Package installation complete!"
}

main "$@"
