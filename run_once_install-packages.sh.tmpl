#!/usr/bin/env bash

set -euo pipefail

cmd_exists() { command -v "$1" >/dev/null 2>&1; }

install_homebrew_if_needed() {
  if [[ "$(uname)" == "Darwin" ]] && ! cmd_exists brew; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  fi
}

{{ if eq .chezmoi.os "linux" -}}
install_linux_packages() {
  echo "==> Installing Linux packages..."
  sudo apt-get update
  sudo apt-get install -y \
    build-essential \
    tmux \
    neovim \
    fzf \
    ripgrep \
    fd-find \
    direnv \
    ncurses-term

  # lsd (apt에 없어서 직접 설치)
  if ! cmd_exists lsd; then
    echo "==> Installing lsd..."
    LSD_VERSION=$(curl -s https://api.github.com/repos/lsd-rs/lsd/releases/latest | grep -oP '"tag_name": "v?\K[^"]+')
    curl -fsSL "https://github.com/lsd-rs/lsd/releases/download/v${LSD_VERSION}/lsd_${LSD_VERSION}_{{ .chezmoi.arch }}.deb" -o /tmp/lsd.deb
    sudo dpkg -i /tmp/lsd.deb
    rm /tmp/lsd.deb
  fi

  # mise
  if ! cmd_exists mise && [[ ! -f ~/.local/bin/mise ]]; then
    echo "==> Installing mise..."
    curl https://mise.run | sh
  fi

  # starship
  if ! cmd_exists starship && [[ ! -f ~/.local/bin/starship ]]; then
    echo "==> Installing starship..."
    curl -sS https://starship.rs/install.sh | sh -s -- -y -b ~/.local/bin
  fi

  # atuin
  if [[ ! -f ~/.atuin/bin/atuin ]]; then
    echo "==> Installing atuin..."
    curl --proto '=https' --tlsv1.2 -LsSf https://setup.atuin.sh | sh
  fi

  # zoxide
  if ! cmd_exists zoxide && [[ ! -f ~/.local/bin/zoxide ]]; then
    echo "==> Installing zoxide..."
    curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
  fi

  # Set zsh as default shell
  if [[ "$SHELL" != *"zsh"* ]]; then
    echo "==> Setting zsh as default shell..."
    sudo chsh -s "$(which zsh)" "$USER"
  fi
}
{{ end -}}

main() {
  install_homebrew_if_needed
{{ if eq .chezmoi.os "linux" -}}
  install_linux_packages
{{ end -}}
}

main "$@"
