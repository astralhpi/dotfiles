# PATH 설정 (먼저 로드)
export PATH="$HOME/.local/bin:$HOME/.atuin/bin:$PATH"

if [[ ! -s "${ZDOTDIR:-$HOME}/.zshrc_local" ]]; then
  touch "${ZDOTDIR:-$HOME}/.zshrc_local"
fi
source "${ZDOTDIR:-$HOME}/.zshrc_local"

# Install zinit if not installed
if [[ ! -f $HOME/.local/share/zinit/zinit.git/zinit.zsh ]]; then
    print -P "%F{33} %F{220}Installing %F{33}ZDHARMA-CONTINUUM%F{220} Initiative Plugin Manager (%F{33}zdharma-continuum/zinit%F{220})…%f"
    command mkdir -p "$HOME/.local/share/zinit" && command chmod g-rwX "$HOME/.local/share/zinit"
    command git clone https://github.com/zdharma-continuum/zinit "$HOME/.local/share/zinit/zinit.git" && \
        print -P "%F{33} %F{34}Installation successful.%f%b" || \
        print -P "%F{160} The clone has failed.%f%b"
fi

source $HOME/.local/share/zinit/zinit.git/zinit.zsh
autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit

{{ if eq .chezmoi.os "darwin" -}}
# brew (macOS)
if [[ ":$PATH:" != *":/opt/homebrew/bin:"* ]]; then
  zinit id-as"brew" as=null atclone'/opt/homebrew/bin/brew shellenv > brew.zsh' \
    atpull'%atclone' \
    src"brew.zsh" for \
    zdharma-continuum/null
fi
{{ end -}}

# z-a-bin-gem-node
zinit light zdharma-continuum/zinit-annex-bin-gem-node
zinit light zdharma-continuum/zinit-annex-patch-dl

# prezto
zstyle ':prezto:module:editor' key-bindings 'vi'
zstyle ':prezto:module:terminal' auto-title 'no'
zstyle ':prezto:module:utility:grep' color 'yes'
zstyle ':prezto:module:utility:diff' color 'yes'
zstyle ':prezto:module:utility:make' color 'yes'

zinit snippet PZTM::environment
zinit ice wait lucid
zinit snippet PZTM::completion
zinit ice wait lucid
zinit snippet PZTM::directory
zinit snippet PZTM::editor
zinit ice wait lucid
zinit snippet PZTM::gnu-utility
zinit ice wait lucid
zinit snippet PZTM::utility

# vim mode
zinit ice depth=1
zinit light jeffreytse/zsh-vi-mode

# oh-my-zsh
zinit ice wait lucid
zinit snippet OMZP::fzf

# forgit
zinit ice wait lucid
zinit light wfxr/forgit

# zsh-completions & fast-syntax-highlighting
zinit wait lucid for \
 atinit"ZINIT[COMPINIT_OPTS]=-C; zicompinit; zicdreplay" \
    zdharma-continuum/fast-syntax-highlighting \
 blockf \
    zsh-users/zsh-completions \
 atload"!_zsh_autosuggest_start" \
    zsh-users/zsh-autosuggestions

zinit id-as"direnv" wait lucid as=null atclone'direnv hook zsh > zhook.zsh' \
  atpull'%atclone' \
  src"zhook.zsh" for \
  zdharma-continuum/null

# fzf
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
export FZF_CTRL_T_OPTS="--preview 'bat --style=numbers --color=always --line-range :200 {}'"

# thefuck
zinit ice wait'1' lucid
zinit light laggardkernel/zsh-thefuck

# atuin
zinit id-as"atuin" wait lucid as=null atclone'atuin init zsh --disable-up-arrow > zhook.zsh' \
  atpull'%atclone' \
  src"zhook.zsh" for \
  zdharma-continuum/null

# starship (zsh-vi-mode 호환)
zinit id-as"starship" as=null atclone'starship init zsh > zhook.zsh' \
  atpull'%atclone' \
  src"zhook.zsh" for \
  zdharma-continuum/null

# alias
alias vim=nvim
alias ls='lsd'
alias l='ls -l'
alias la='ls -a'
alias kb='kubectl'
alias nd='nerdctl'

# uvx fallback (mise shim 이슈 대비)
command -v uvx >/dev/null 2>&1 || alias uvx='uv tool run'

if [ "$TERM" = "xterm-kitty" ]; then
  alias ssh="kitty +kitten ssh"
fi

# color
export CLICOLOR=1;

function coalesce { print "${${(s: :)@}[1]}" }
{{ if eq .chezmoi.os "darwin" -}}
export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
{{ end -}}

# zellij
alias zj="zellij"
alias zjl="zellij list-sessions"
alias zjk="zellij kill-session"
alias zjka="zellij kill-all-sessions"

# 세션 있으면 attach, 없으면 새로 생성
zja() {
  if [[ -z "$1" ]]; then
    # 인자 없으면 fzf로 세션 선택
    local session
    session=$(zellij list-sessions -n 2>/dev/null | fzf --height=40% --reverse)
    if [[ -n "$session" ]]; then
      zellij attach "$session"
    else
      zellij
    fi
  else
    zellij attach "$1" 2>/dev/null || zellij --session "$1"
  fi
}

# tmux
alias tx="tmux"
alias txl="tmux ls"
alias txk="tmux kill-session -t"
alias txka="tmux kill-server"

# 세션 있으면 attach, 없으면 새로 생성
txa() {
  if [[ -z "$1" ]]; then
    local session
    session=$(tmux list-sessions -F "#{session_name}" 2>/dev/null | fzf --height=40% --reverse)
    if [[ -n "$session" ]]; then
      tmux attach -t "$session"
    elif [[ -n "$TMUX" ]]; then
      echo "Already in tmux session"
    else
      tmux new-session
    fi
  else
    tmux attach -t "$1" 2>/dev/null || tmux new-session -s "$1"
  fi
}

# tmuxp: fzf로 yaml 선택해서 로드
txp() {
  local config
  if [[ -z "$1" ]]; then
    config=$(ls ~/.config/tmuxp/*.yaml 2>/dev/null | xargs -n1 basename | sed 's/.yaml$//' | fzf --height=40% --reverse --prompt="tmuxp> ")
    [[ -n "$config" ]] && tmuxp load "$config"
  else
    tmuxp load "$1"
  fi
}

# history
HISTSIZE=999999999
SAVEHIST=999999999
setopt    appendhistory
setopt    sharehistory
setopt    incappendhistory

{{ if eq .chezmoi.os "darwin" -}}
alias tailscale="/Applications/Tailscale.app/Contents/MacOS/Tailscale"
{{ end -}}

alias qr='qrencode -m 2 -t utf8 <<< "$1"'

# clipboard - SSH 연결 시 OSC 52, 로컬은 네이티브
if [[ -n "$SSH_CONNECTION" ]]; then
  # 원격: OSC 52 사용
  clip() {
    local data=$(cat "$@" | base64 | tr -d '\n')
    printf "\033]52;c;%s\007" "$data"
  }
else
  # 로컬: 네이티브 클립보드
  {{ if eq .chezmoi.os "darwin" -}}
  alias clip='pbcopy'
  {{ else -}}
  if command -v wl-copy &>/dev/null; then
    alias clip='wl-copy'
  elif command -v xclip &>/dev/null; then
    alias clip='xclip -selection clipboard'
  fi
  {{ end -}}
fi

# 1password
zinit id-as"op" wait'1' lucid as=null atclone'op completion zsh > zhook.zsh' \
  atpull'%atclone' \
  src"zhook.zsh" for \
  zdharma-continuum/null

# copilot cli
zinit id-as"github-copilot-cli" wait'1' lucid as=null atclone'github-copilot-cli alias -- "$0" > zhook.zsh' \
  atpull'%atclone' \
  src"zhook.zsh" for \
  zdharma-continuum/null

export XDG_CONFIG_HOME="$HOME/.config"

# zoxide
zinit id-as"z" as=null atclone'zoxide init zsh > zhook.zsh' \
  atpull'%atclone' \
  src"zhook.zsh" for \
  zdharma-continuum/null

# mise (runtime/tool version manager)
zinit id-as"mise" as=null atclone'mise activate zsh > zhook.zsh' \
  atpull'%atclone' \
  src"zhook.zsh" for \
  zdharma-continuum/null

export GOOGLE_CLOUD_PROJECT="watnee"
