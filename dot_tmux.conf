# =============================================================================
# tmux configuration - zellij 수준 이상의 기능
# =============================================================================

# -----------------------------------------------------------------------------
# 기본 설정 (tmux-sensible 포함)
# -----------------------------------------------------------------------------

set -g default-shell /bin/zsh

# 터미널 설정
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"            # true color
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'   # undercurl
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # undercurl colors

# 히스토리 & 성능
set -g history-limit 50000
set -g display-time 4000
set -sg escape-time 10
set -g focus-events on

# 인덱스 1부터 시작
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# 마우스 지원
set -g mouse on

# 클립보드 (OSC52 - SSH에서도 동작)
set -g set-clipboard on

# 타이틀
set -g set-titles on
set -g set-titles-string '#{session_name}:#{window_name}'

# Activity
set -g visual-activity off
set -g monitor-activity off

# 이미지 패스스루 (kitty, wezterm 등)
set -gq allow-passthrough on

# -----------------------------------------------------------------------------
# Prefix 키
# -----------------------------------------------------------------------------

set -g prefix C-a
unbind C-b
bind C-a send-prefix

# -----------------------------------------------------------------------------
# 키바인딩 - Pane 관리
# -----------------------------------------------------------------------------

# 분할 (현재 경로 유지)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind '\' split-window -h -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}"

# 이동 (vim 스타일)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# 리사이즈 (반복 가능)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# 줌 토글
bind z resize-pane -Z

# Pane 동기화 토글
bind s setw synchronize-panes \; display "Sync #{?synchronize-panes,ON,OFF}"

# Pane을 새 윈도우로 분리
bind ! break-pane

# Pane 스왑
bind '{' swap-pane -U
bind '}' swap-pane -D

# -----------------------------------------------------------------------------
# 키바인딩 - Window/Tab 관리
# -----------------------------------------------------------------------------

# 새 윈도우 (현재 경로 유지)
bind c new-window -c "#{pane_current_path}"

# 윈도우 이동
bind -r n next-window
bind -r p previous-window
bind Tab last-window

# 윈도우 번호로 이동
bind 1 select-window -t 1
bind 2 select-window -t 2
bind 3 select-window -t 3
bind 4 select-window -t 4
bind 5 select-window -t 5
bind 6 select-window -t 6
bind 7 select-window -t 7
bind 8 select-window -t 8
bind 9 select-window -t 9

# 윈도우 순서 변경
bind -r < swap-window -t -1 \; select-window -t -1
bind -r > swap-window -t +1 \; select-window -t +1

# 윈도우 이름 변경
bind , command-prompt -I "#W" "rename-window '%%'"

# 윈도우 닫기
bind & confirm-before -p "kill-window #W? (y/n)" kill-window
bind x confirm-before -p "kill-pane #P? (y/n)" kill-pane

# -----------------------------------------------------------------------------
# 키바인딩 - Copy 모드 (vim 스타일)
# -----------------------------------------------------------------------------

setw -g mode-keys vi

# [ 로 copy 모드 진입 (tmux 기본)
bind [ copy-mode
bind ] paste-buffer

# vim 스타일 선택/복사
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-pipe-and-cancel
bind -T copy-mode-vi Enter send -X copy-pipe-and-cancel

# 검색
bind -T copy-mode-vi / command-prompt -i -p "search down:" "send -X search-forward-incremental \"%%%\""
bind -T copy-mode-vi ? command-prompt -i -p "search up:" "send -X search-backward-incremental \"%%%\""

# -----------------------------------------------------------------------------
# 키바인딩 - 세션 관리
# -----------------------------------------------------------------------------

# 세션 선택 (내장)
bind w choose-tree -Zs

# 새 세션
bind N command-prompt -p "new session:" "new-session -s '%%'"

# 세션 이름 변경
bind '$' command-prompt -I "#S" "rename-session '%%'"

# 마지막 세션으로 전환
bind m switch-client -l

# 세션 경로 변경
bind M-c attach-session -c "#{pane_current_path}" \; display "Session path: #{pane_current_path}"

# -----------------------------------------------------------------------------
# 키바인딩 - 유틸리티
# -----------------------------------------------------------------------------

# 설정 리로드
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# 레이아웃 순환 (zellij의 Space와 유사)
bind Space next-layout

# Clear scrollback
bind C-l send-keys C-l \; clear-history

# Popup 터미널 (floating pane 느낌)
bind f display-popup -E -w 80% -h 80% -d "#{pane_current_path}"

# Popup에서 lazygit
bind g display-popup -E -w 90% -h 90% -d "#{pane_current_path}" "lazygit"

# Command Palette (prefix + P)
# 형식: 단축키:::설명:::명령어
bind P display-popup -E -w 70% -h 70% "cat <<'EOF' | fzf --prompt='  ' --header='Command Palette (prefix = Ctrl+a)' --reverse --delimiter=':::' --with-nth=1,2 --tabstop=16 | cut -d':::' -f3 | xargs -I {} tmux {}
c	새 윈도우:::new-window -c '#{pane_current_path}'
|	세로 분할:::split-window -h -c '#{pane_current_path}'
-	가로 분할:::split-window -v -c '#{pane_current_path}'
x	pane 닫기:::confirm-before -p 'kill-pane?' kill-pane
&	윈도우 닫기:::confirm-before -p 'kill-window?' kill-window
n	다음 윈도우:::next-window
p	이전 윈도우:::previous-window
Tab	마지막 윈도우:::last-window
w	세션/윈도우 트리:::choose-tree -Zs
,	윈도우 이름 변경:::command-prompt -I '#W' 'rename-window \"%%\"'
$	세션 이름 변경:::command-prompt -I '#S' 'rename-session \"%%\"'
N	새 세션:::command-prompt -p 'new session:' 'new-session -s \"%%\"'
d	Detach:::detach-client
z	pane 줌 토글:::resize-pane -Z
s	pane 동기화 토글:::setw synchronize-panes
Space	레이아웃 순환:::next-layout
f	Floating popup:::display-popup -E -w 80% -h 80% -d '#{pane_current_path}'
g	Lazygit:::display-popup -E -w 90% -h 90% -d '#{pane_current_path}' lazygit
[	Copy 모드:::copy-mode
u	URL 선택:::run '~/.tmux/plugins/tmux-fzf-url/fzf-url.sh'
C-s	세션 저장:::run '~/.tmux/plugins/tmux-resurrect/scripts/save.sh'
C-r	세션 복구:::run '~/.tmux/plugins/tmux-resurrect/scripts/restore.sh'
r	설정 리로드:::source-file ~/.tmux.conf; display 'Reloaded!'
?	키바인딩 목록:::list-keys
EOF"

# -----------------------------------------------------------------------------
# 테마 - Catppuccin
# -----------------------------------------------------------------------------

set -g @catppuccin_flavor 'macchiato'
set -g @catppuccin_window_status_style "rounded"
set -g @catppuccin_window_flags "icon"

# 윈도우 탭에 표시할 내용 (catppuccin 로드 전에 설정!)
set -g @catppuccin_window_text "#I:#{pane_current_command}"
set -g @catppuccin_window_current_text "#I:#{pane_current_command}"

# 상태바 위치
set -g status-position bottom
set -g status-interval 5

# 왼쪽: 세션명
set -g status-left-length 100
set -g status-left ""

# 오른쪽: git + 상태
set -g status-right-length 100
set -g status-right ""

# Catppuccin 로드
run ~/.tmux/plugins/catppuccin/catppuccin.tmux

# 상태바 오른쪽: [git] | [경로] | [세션]
# gitmux (설치되어 있으면)
if-shell "command -v gitmux" {
  set -g status-right '#(gitmux -cfg ~/.gitmux.conf "#{pane_current_path}") #[fg=brightblack]│ #[fg=blue]#(echo "#{pane_current_path}" | sed "s|$HOME|~|" | sed "s|\\([^/]\\)[^/]*/|\\1/|g") #[fg=brightblack]│ '
} {
  set -g status-right '#[fg=blue]#(echo "#{pane_current_path}" | sed "s|$HOME|~|" | sed "s|\\([^/]\\)[^/]*/|\\1/|g") #[fg=brightblack]│ '
}

set -agF status-right "#{E:@catppuccin_status_session}"

# -----------------------------------------------------------------------------
# 플러그인 로드 (TPM 없이)
# -----------------------------------------------------------------------------

# tmux-which-key
if-shell "test -f ~/.tmux/plugins/tmux-which-key/plugin.sh.tmux" {
  run ~/.tmux/plugins/tmux-which-key/plugin.sh.tmux
}

# tmux-fzf
if-shell "test -d ~/.tmux/plugins/tmux-fzf" {
  set -g @tmux-fzf-launch-key "C-f"
  run ~/.tmux/plugins/tmux-fzf/main.tmux
}

# tmux-resurrect (세션 저장/복구)
# prefix + Ctrl+s: 저장, prefix + Ctrl+r: 복구
if-shell "test -d ~/.tmux/plugins/tmux-resurrect" {
  set -g @resurrect-capture-pane-contents 'on'
  set -g @resurrect-strategy-nvim 'session'
  run ~/.tmux/plugins/tmux-resurrect/resurrect.tmux
}

# tmux-fzf-url (URL picker)
# prefix + u: URL 선택해서 열기
if-shell "test -d ~/.tmux/plugins/tmux-fzf-url" {
  set -g @fzf-url-bind 'u'
  run ~/.tmux/plugins/tmux-fzf-url/fzf-url.tmux
}

# extrakto (output에서 텍스트 추출)
# prefix + tab: 화면에서 텍스트 선택해서 복사/삽입
if-shell "test -d ~/.tmux/plugins/extrakto" {
  set -g @extrakto_key 'tab'
  set -g @extrakto_split_size '15'
  set -g @extrakto_clip_tool 'auto'
  run ~/.tmux/plugins/extrakto/extrakto.tmux
}
